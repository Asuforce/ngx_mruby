{"name":"ngx_mruby","tagline":"A Fast and Memory-Efficient Web Server Extension Mechanism Using Scripting Language mruby for nginx","body":"# Welcome to ngx_mruby Pages  [![Build Status](https://travis-ci.org/matsumoto-r/ngx_mruby.png?branch=master)](https://travis-ci.org/matsumoto-r/ngx_mruby)\r\n\r\n[![ngx_mruby mod_mruby performance](http://blog.matsumoto-r.jp/wp-content/uploads/2013/12/performance_20131226.png)](http://blog.matsumoto-r.jp/?p=3974)\r\n\r\nâ€» [hello world simple benchmark, see details of blog entry.](http://blog.matsumoto-r.jp/?p=3974)\r\n\r\n## What's ngx_mruby\r\n__ngx_mruby is A Fast and Memory-Efficient Web Server Extension Mechanism Using Scripting Language mruby for nginx.__\r\n\r\n- ngx_mruby is to provide an alternative to lua-nginx-module or [mod_mruby of Apache httpd](http://matsumoto-r.github.io/mod_mruby/). \r\n- Unified Ruby Code between Apache(mod_mruby), nginx(ngx_mruby) and other Web server software(plan) for Web server extensions.\r\n- You can implemet nginx modules by Ruby scripts on nginx!\r\n- You can implement some Web server software extensions by same Ruby code (as possible) \r\n- Supported nginx __1.2/1.3/1.4/1.5.*__\r\n- [Benchmark between ngx_mruby(19423.42 req/sec) and lua-nginx-module(13894.30 req/sec)](https://gist.github.com/matsumoto-r/6930672)\r\n\r\n```ruby\r\n# location /proxy {\r\n#   mruby_set $backend \"/path/to/proxy.rb\";\r\n#   proxy_pass   http://$backend;\r\n# }\r\n\r\nbackends = [\r\n  \"test1\",\r\n  \"test2\",\r\n  \"test3\",\r\n]\r\n\r\nr = Redis.new \"192.168.12.251\", 6379\r\nr.get backends[rand(backends.length)]\r\n```\r\n\r\n- see [examples](https://github.com/matsumoto-r/ngx_mruby/blob/master/example/nginx.conf)\r\n- __Sample of Unified Ruby Code between Apache(mod_mruby) and nginx(ngx_mruby) for Web server extensions__\r\n- You can implement some Web server software extensions by same Ruby code (as possible) \r\n\r\n```ruby\r\n# Unified Ruby Code between Apache(mod_mruby) and nginx(ngx_mruby)\r\n# for Web server extensions.\r\n#\r\n# Apache httpd.conf by mod_mruby\r\n# \r\n# <Location /mruby>\r\n#     mrubyHandlerMiddle \"/path/to/unified_hello.rb\"\r\n# </Location>\r\n#\r\n# nginx ngxin.conf by ngx_mruby\r\n#\r\n# location /mruby {\r\n#     mruby_content_handler \"/path/to/unified_hello.rb\";\r\n# }\r\n#\r\n\r\nif server_name == \"NGINX\"\r\n  Server = Nginx\r\nelsif server_name == \"Apache\"\r\n  Server = Apache\r\nend\r\n\r\nServer::rputs \"Hello #{Server::module_name}/#{Server::module_version} world!\"\r\n# mod_mruby => \"Hello mod_mruby/0.9.3 world!\"\r\n# ngx_mruby => \"Hello ngx_mruby/0.0.1 world!\"\r\n```\r\n\r\n## Abstract\r\n\r\nAs the increase of large-scale and complex Web services, not only a development of Web applications but also an implementation of Web server extensions is required in many cases. The Web server extensions were mainly implemented in C language because of fast and memory-efficient behavior, but extension methods using scripting language are proposed with consideration of maintainability and productivity. However, if the existing methods primarily intended to enhance not the implementation of Web applications but the implementation of internal processing of the Web server, the problem remains in terms of fast, memory-efficiency and safety. Therefore, we propose a fast and memory-efficient Web server extension mechanism using scripting language. We design the architecture that a server process create the region to save the state of the interpreter at the server process startup, and multiple scripts share the region in order to process fast when the script is called as internal processing from a Web server process. The server process free the global variables table, the exception flag and the byte-code which cause the increase of memory usage mainly, in order to reduce the memory usage and extend safely by preventing interference between each scripts because of sharing the region. We implement the mechanism that can extend the internal processing of nginx easily by Ruby scripts using nginx and embeddable scripting language mruby. It's called \"ngx_mruby\".\r\n\r\n## How to use\r\n\r\n### 1. Download\r\n\r\n```bash\r\n$ git clone git://github.com/matsumoto-r/ngx_mruby.git\r\n$ cd ngx_mruby\r\n$ git submodule init\r\n$ git submodule update\r\n```\r\n\r\n- if you want __more features__, you can get [mrbgems](https://github.com/mruby/mruby/wiki/Related-Projects) and write to [build_config.rb](https://github.com/matsumoto-r/ngx_mruby/blob/master/build_config.rb)\r\n- for example, use mruby-io and implement [file base access check like .htaccess](https://gist.github.com/matsumoto-r/7150832).\r\n- default mrbgems\r\n  - gembox: mruby/mruby default mrbgems, mruby-randoma, mruby-env, mruby-print...\r\n  - mruby-process: Process ::fork, ::kill, ::pid, ::ppid, ::waitpid...\r\n  - mruby-pack: pack, unpack...\r\n  - mruby-digest: MD5, RMD160, SHA1, SHA256, SHA384, SHA512 and HMAC Digests\r\n  - mruby-jason: JSON::parse, JSON::stringify\r\n  - mruby-redis: Redis#set, get, [], []=...\r\n  - mruby-sleep: sleep, usleep...\r\n  - mruby-userdata: https://github.com/matsumoto-r/mruby-userdata\r\n  - mruby-hs-regexp: regexp engine\r\n  - mruby-io: https://github.com/iij/mruby-io\r\n- __We should implement ngx_mruby/mod_mruby extensions as mrbgems, as possible.__\r\n- __We recommend the contribute to mruby by implementing mrbgems.__\r\n\r\n### 2. Build \r\nUsing build.sh\r\n```bash\r\n# Default install\r\n#  download nginx into ./build/\r\n#  build with ngx_mruby into ./build/nginx\r\n\r\nsh build.sh\r\n```\r\n```bash\r\n# install with ENV\r\n\r\nNGINX_CONFIG_OPT_ENV='--prefix=/usr/local/nginx-1.4.4' NGINX_SRC_ENV='/usr/local/src/nginx-1.4.4' sh build.sh\r\n```\r\nor Download [Nginx](http://nginx.org/en/download.html), unpack, use configure for ngx_mruby, mruby build, ngx_mruby build.\r\n```bash\r\n$ cd ${NGX_MRUBY_SRC}\r\n$ ./configure --with-ngx-src-root=${NGINX_SRC} --with-ngx-config-opt=\"--prefix=/usr/local/nginx\"\r\n$ make build_mruby\r\n$ make\r\n```\r\nor configure with ```--add-module=${NGX_MRUBY_SRC}``` for nginx and make it\r\n```bash\r\n$ cd ${NGINX_SRC}\r\n$ ./configure --prefix=/usr/local/nginx --add-module=${NGX_MRUBY_SRC} --add-module=${NGX_MRUBY_SRC}/dependence/ngx_devel_kit --add-module=${SOME_OTHER_MODULE}\r\n$ make\r\n```\r\n\r\n### 3. Install\r\n```bash\r\n$ sudo make install\r\n```\r\n### 4. Add setting\r\n```nginx\r\nlocation /mruby {\r\n    mruby_content_handler '/usr/local/nginx/html/unified_hello.rb';\r\n}\r\n```\r\nor file cache enabled\r\n```nginx\r\nlocation /mruby {\r\n    mruby_content_handler '/usr/local/nginx/html/unified_hello.rb' cache;\r\n}\r\n```\r\nor inline code (cached)\r\n```nginx\r\nlocation /mruby {\r\n    mruby_content_handler_code '\r\n      \r\n      if server_name == \"NGINX\"\r\n        Server = Nginx\r\n      elsif server_name == \"Apache\"\r\n        Server = Apache\r\n      end\r\n      \r\n      Server::rputs \"Hello #{Server::module_name}/#{Server::module_version} world!\"\r\n    \r\n    ';\r\n}\r\n```\r\nor Add handler\r\n```nginx\r\nlocation ~ \\.rb$ {\r\n    mruby_add_handler on;\r\n}\r\n```\r\n### 5. Create mruby script /usr/local/nginx/html/unified_hello.rb'\r\n```ruby\r\nif server_name == \"NGINX\"\r\n  Server = Nginx\r\nelsif server_name == \"Apache\"\r\n  Server = Apache\r\nend\r\n\r\nServer::rputs \"Hello #{Server::module_name}/#{Server::module_version} world!\"\r\n```\r\n\r\n### 6. Start nginx\r\n```bash\r\n/usr/local/nginx/sbin/nginx\r\n```\r\n### 7. Access http://127.0.0.1/mruby or http://127.0.0.1/unified_hello.rb\r\n```\r\nHello ngx_mruby/0.0.1 world!\r\n```\r\n\r\nDisplay above. Welcome mruby world for nginx!!\r\n\r\n\r\n# License\r\nunder the MIT License:\r\n\r\n* http://www.opensource.org/licenses/mit-license.php\r\n\r\n","google":"","note":"Don't delete this file! It's used internally to help with page regeneration."}