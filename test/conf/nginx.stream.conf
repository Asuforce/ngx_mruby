stream {
  upstream dynamic_server0 {
    server 127.0.0.1:58080;
  }
  upstream dynamic_server1 {
    server 127.0.0.1:58081;
  }

  server {
      listen 12346;
      mruby_stream '
        c = Nginx::Stream::Connection.new "dynamic_server0"
        c.upstream_server = "127.0.0.1:58081"
      ';
      proxy_pass dynamic_server0;
  }

  # test for dynamic tcp load balancer
  # upstream changed from 127.0.0.1:58081 to 127.0.0.1:58080 in mruby
  server {
      listen 12345;
      mruby_stream '
        c = Nginx::Stream::Connection.new "dynamic_server1"
        c.upstream_server = "127.0.0.1:58080"
      ';
      proxy_pass dynamic_server1;
  }
}

